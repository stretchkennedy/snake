<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css"></link>
    </head>
    <body>
        <script src=/socket.io/socket.io.js></script>
        <script src=/jquery/jquery.min.js></script>
        <script>        
            var socket = io.connect(location.protocol + '//' + location.host)
            var id
            var snakes
            var fruit
            var width = 0
            var height = 0
            
            Number.prototype.mod = function(n) {
                return ((this%n)+n)%n;
            }
            
            function registerKeys() {
                var larrow = 37
                var left = 180
                var uarrow = 38
                var up = 90
                var rarrow = 39
                var right = 0
                var darrow = 40
                var down = 270
                $(document).keydown(function (event) {
                    var d
                    if (event.which == larrow)
                        d = left
                    else if (event.which == rarrow)
                        d = right
                    else if (event.which == darrow)
                        d = down
                    else if (event.which == uarrow)
                        d = up
                    if (d != undefined) socket.emit('turn', {d: d})
                })
            }
            
            function unregisterKeys() {
                $(document).off('keydown')
            }
            
            function tilediv(x, y) {
                return $('.x' + x + '.y' + y)
            }

            function updateSnakes(ids) {
                for (var i = 0; i < ids.length; i++) {
                    var snake = snakes[ids[i]]
                    
                    // grow snake's head
                    var head = snake.pieces[0]
                    if (snake.d == 0)
                        snake.pieces.unshift({x: (head.x + 1).mod(width), y: head.y})
                    else if(snake.d == 90)
                        snake.pieces.unshift({x: head.x, y: (head.y - 1).mod(height)})
                    else if(snake.d == 180)
                        snake.pieces.unshift({x: (head.x - 1).mod(width), y: head.y})
                    else if(snake.d == 270)
                        snake.pieces.unshift({x: head.x, y: (head.y + 1).mod(height)})
                    
                    // shorten snake's tail
                    if (snake.elongating > 0) {
                        snake.elongating -= 1
                    }
                    else {
                        snake.pieces.pop()
                    }
                }
            }
            
            function updateView() {
                $('div#game div.tile').removeClass('you them fruit')
                for (sid in snakes) {
                    var snake = snakes[sid]
                    var cname = 'them'
                    if (sid == id) cname = 'you'
                    for (var i = 0; i < snake.pieces.length; i++) {
                        var x = snake.pieces[i].x
                        var y = snake.pieces[i].y
                        tilediv(x, y).addClass(cname)
                    }
                    for (var i = 0; i < fruit.length; i++) {
                        tilediv(fruit[i].x, fruit[i].y).addClass('fruit')
                    }
                }
            }
            
            function print(message) {
                $('<p>' + message + '</p>')
                .appendTo($('div#messageBox'))
                .delay(2000)
                .fadeOut(1000, function() {
                    this.remove()
                })
            }
            
            socket.on('accept', function (params) {
                width = params['width']
                height = params['height']
                snakes = {}
                fruit = {}
                $('div#game').html('')
                for(var y = 0; y < height; y++) {
                    var row = $('<div/>', {class: 'row'})
                    row.appendTo($('div#game'))
                    for(var x = 0; x < height; x++) {
                        var div = $('<div/>', {class: 'tile'})
                        div.addClass('x' + x)
                        div.addClass('y' + y)
                        div.appendTo(row)
                    }
                }
                registerKeys()
            })
            
            function mergeSnakes(newSnakes) {
                for (num in newSnakes) {
                    snakes[num] = newSnakes[num]
                }
            }
            
            socket.on('spawn', function (params) {
                $('.menu').hide()
                $('#game').removeClass("faded")
                id = params['id']
                $("#myID").html('<p>' + id + '</p>')
            })
            
            socket.on('create', function (params) {
                mergeSnakes(params['snakes'])
                if ('fruit' in params)
                    fruit = params['fruit']
                updateView()
            })
            
            socket.on('update', function (params) {
                mergeSnakes(params['snakes'])
                
                var changed = []
                for(num in params['snakes']) { changed.push(num) }
                var all = []
                for(num in snakes) { all.push(num) }
                var unchanged = $(all).not(changed).get();
                updateSnakes(unchanged)
                
                fruit = params['fruit']
                updateView()
            })
            
            socket.on('die', function (params) {
                lostid = params['id']
                var player = 'Player ' + lostid
                if (lostid == id) {
                    $('.menu').show()
                    $('#game').addClass("faded")
                    player = 'You'
                }
                print(player + ' Died')
                delete snakes[lostid]
            })
            
            socket.on('left', function (params) {
                leftid = params['id']
                print('Player ' + leftid + ' Left')
                delete snakes[leftid]
            })
            
            $(document).ready(function() {
                $('.respawn').click(function() {
                    socket.emit('respawn')
                })
            })
        </script>
        <div class="menu">
            <div class="respawn button">
                <p>Respawn</p>
            </div>
        </div>
        <div class="container">
            <div id="game" class="faded">
            </div>
            <div id="myID">
            </div>
            <div id="messageBox">
            </div>
            <br/>
        </div>
    </body>
</html>
