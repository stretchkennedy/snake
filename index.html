<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css"></link>
    </head>
    <body>
        <script src=/socket.io/socket.io.js></script>
        <script src=/jquery/jquery.min.js></script>
        <script src=/jquery/jquery.caret.js></script>
        <script src=/string/string.min.js></script>
        <script>        
            var socket = io.connect(location.protocol + '//' + location.host)
            var id
            var snakes
            var names = {}
            var fruit
            var kills = 0
            var width = 0
            var height = 0
            
            Number.prototype.mod = function(n) {
                return ((this%n)+n)%n;
            }
            
            function registerKeys() {
                var larrow = 37
                var left = 180
                var uarrow = 38
                var up = 90
                var rarrow = 39
                var right = 0
                var darrow = 40
                var down = 270
                
                var enter = 13
                $(document).keydown(function (event) {
                    // send turn event
                    var d
                    if (event.which == larrow)
                        d = left
                    else if (event.which == rarrow)
                        d = right
                    else if (event.which == darrow)
                        d = down
                    else if (event.which == uarrow)
                        d = up
                    if (d != undefined) {
                        socket.emit('turn', {d: d})
                    }
                })
                $('.textbox').keydown(function (event) {
                    if (event.which == larrow ||
                        event.which == rarrow ||
                        event.which == uarrow ||
                        event.which == darrow) {
                        // return caret to end of box
                        event.preventDefault()
                    }
                })
                $('.textbox').keyup(function (event) {
                    // return caret to end of box
                    $(this).caretToEnd()
                })
                $('#messageInput').keydown(function (event) {
                    if (event.which == enter) {
                        socket.emit('msg', {m: $(this).val()})
                        $(this).val('')
                    }
                })
            }
            
            function unregisterKeys() {
                $(document).off('keydown')
            }
            
            function tilediv(x, y) {
                return $('.x' + x + '.y' + y)
            }

            function updateSnakes(ids) {
                for (var i = 0; i < ids.length; i++) {
                    var snake = snakes[ids[i]]
                    
                    // grow snake's head
                    var head = snake.pieces[0]
                    if (snake.d == 0)
                        snake.pieces.unshift({x: (head.x + 1).mod(width), y: head.y})
                    else if(snake.d == 90)
                        snake.pieces.unshift({x: head.x, y: (head.y - 1).mod(height)})
                    else if(snake.d == 180)
                        snake.pieces.unshift({x: (head.x - 1).mod(width), y: head.y})
                    else if(snake.d == 270)
                        snake.pieces.unshift({x: head.x, y: (head.y + 1).mod(height)})
                    
                    // shorten snake's tail
                    if (snake.elongating > 0) {
                        snake.elongating -= 1
                    }
                    else {
                        snake.pieces.pop()
                    }
                }
            }
            
            function updateKills() {
                $('#kills').html('<p>Kills: ' + kills + '</p>')
            }
            
            function addBoard() {
                board = $('div#board')
                board.html('')
                for(var y = 0; y < height; y++) {
                    var row = $('<div/>', {class: 'row'})
                    row.appendTo(board)
                    for(var x = 0; x < height; x++) {
                        var div = $('<div/>', {class: 'tile'})
                        div.addClass('x' + x)
                        div.addClass('y' + y)
                        div.appendTo(row)
                    }
                }
                board.append($('<div class="clear"></div>'))
            }
            
            function updateView() {
                $('div#board div.tile').removeClass('you them fruit')
                for (var sid in snakes) {
                    var snake = snakes[sid]
                    var cname = 'them'
                    if (sid == id) cname = 'you'
                    for (var i = 0; i < snake.pieces.length; i++) {
                        var x = snake.pieces[i].x
                        var y = snake.pieces[i].y
                        tilediv(x, y).addClass(cname)
                    }
                    for (var i = 0; i < fruit.length; i++) {
                        tilediv(fruit[i].x, fruit[i].y).addClass('fruit')
                    }
                }
            }
            
            function renameSnake() {
                $("#name").val(names[id])
            }
            
            function print(message) {
                $('<p class="message">' + S(message).escapeHTML().s + '</p>')
                    .appendTo($('div#messageBox'))
                var msgdiv = $('#messageBox')
                msgdiv[0].scrollTop = msgdiv[0].scrollHeight
            }
            
            socket.on('accept', function (params) {
                width = params['width']
                height = params['height']
                addBoard()
                snakes = {}
                fruit = {}
                id = params['id']
                registerKeys()
            })
            
            function mergeSnakes(newSnakes) {
                for (num in newSnakes) {
                    snakes[num] = newSnakes[num]
                }
            }
            
            socket.on('spawn', function (params) {
                kills = 0
                updateKills()
                $('.menu').hide()
                $('#board').removeClass("faded")
            })
            
            socket.on('create', function (params) {
                mergeSnakes(params['snakes'])
                if ('fruit' in params)
                    fruit = params['fruit']
                updateView()
            })
            
            socket.on('update', function (params) {
                mergeSnakes(params['snakes'])
                
                var changed = []
                for(num in params['snakes']) { changed.push(num) }
                var all = []
                for(num in snakes) { all.push(num) }
                var unchanged = $(all).not(changed).get();
                updateSnakes(unchanged)
                
                fruit = params['fruit']
                updateView()
            })
            
            socket.on('die', function (params) {
                var lostid = params['id']
                var lostname = names[lostid]
                var killerid = params['killer']
                var killername = names[killerid]
                var message = killername
                if (lostid == id) {
                    $('.menu').show()
                    $('#board').addClass("faded")
                    lostname = 'you'
                    if (killerid == id) {
                        killername = 'yourself'
                    }
                }
                else if (killerid == id) {
                    kills++
                    updateKills()
                    killername = 'you'
                }
                print(killername + ' killed ' + lostname)
                delete snakes[lostid]
            })
            socket.on('left', function (params) {
                var leftid = params['id']
                var name = names[leftid]
                print(name + ' Left')
                delete snakes[leftid]
            })
            socket.on('renamed', function (params) {
                names = params['names']
                if (params['id'] == id) {
                    renameSnake()
                }
            })
            socket.on('msged', function (params) {
                var mid = params['id']
                var name = names[mid] || mid
                var msg = params['m']
                print('<' + name + '>: ' + msg)
            })
            
            $(document).ready(function() {
                $('.respawn').click(function() {
                    socket.emit('respawn')
                })
                
                $('#name').change(function() {
                    socket.emit('rename', {name: $('#name').val()})
                })
            })
        </script>
        <div>
            <div class="menu">
                <div class="respawn button">
                    <p>Respawn</p>
                </div>
            </div>
            <div id="game">
                <div id="board"></div>
                <div class="clear"></div>
                <div>
                    <div class="inputContainer">
                        <input type="text" class="textbox" id="name"/>
                    </div>
                    <div id="kills">
                        <p>Kills: 0</p>
                    </div>
                </div>
            </div>
            <div id="messageContainer">
                <div id="messageBox"></div>
                <div class="inputContainer">
                    <input type="text" class="textbox" id="messageInput"/>
                </div>
            </div>
        </div>
    </body>
</html>
